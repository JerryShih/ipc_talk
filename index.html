<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>IPC 101</title>
        <meta name="description" content="This presentation is generated by vim-reveal and reveal.js.">
        <meta name="author" content='Jerry'>
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <link rel="stylesheet" href="css/reveal.min.css">
        <link rel="stylesheet" href="css/theme/default.css" id="theme">
        <link rel="stylesheet" href="lib/css/zenburn.css">
        <!-- If the query includes 'print-pdf', use the PDF print sheet -->
        <script>
            document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
        </script>
        <!--[if lt IE 9]>
        <script src="lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>

    <body>
        <div class="reveal">
            <div class="slides">

<section data-markdown >
<script type="text/template">
## IPC 101

### Jerry

</script>
</section>
<section data-markdown >
<script type="text/template">
### IPC

* inter-process communication
* share data across multiple processes
* Chrome <=> Content
	* some actions requires chrome privilege

<br/><hr/>

### IPDL

* the language to generate c++ code for message passing
* IPDL file => ipdl.py => c++ ipc code

</script>
</section>
<section data-markdown >
<script type="text/template">
### IPDL Code Generator
```c
                                  PTestParent.h:
                                  class PTestParent
                                  {
                                  protected:
                                    virtual bool RecvChildToParent() = 0;
PTest.ipdl:                         virtual bool RecvBothDirection() = 0;
protocol PTest                    public:
{                                   bool SendParentToChild();
child:                              bool SendBothDirection();
  ParentToChild();                };
parent:                              PTestChild.h:
  ChildToParent();                   class PTestChlid
both:                                {
  BothDirection();                   protected:
};                                     virtual bool RecvParentToChild() = 0;
                                       virtual bool RecvBothDirection() = 0;
                                     public:
                                       bool SendChildToParent();
                                       bool SendBothDirection();
                                     };
```
1. what's actor
	* IPDL will generate two end point for message passing. This two end point are called actor.
2. message direction

</script>
</section>
<section data-markdown >
<script type="text/template">
### Actor Impl

```c
TestChild.h:
#include <PTestChild.h>
class TestChild : public PTestChild
{
  ....
  virtual bool RecvParentToChild() MOZ_OVERRIDE;
  irtual bool RecvBothDirection() MOZ_OVERRIDE;
};
```
```python
moz.build:
include('/ipc/chromium/chromium-config.mozbuild')

IPDL_SOURCES = [
    'ipc/PTest.ipdl',
]
```
</script>
</section>
<section>
<section data-markdown >
<script type="text/template">
### Message Data Type

* c++ primitive type or ipc builtin type(check ipc/ipdl/ipdl/builtin.py)
```
'int32_t'
'uint32_t'
'int64_t'
'nsresult'
'nsString'
'nsCString'
```
* struct
```c
IPDL:
struct Pos
{
  int x;
  int y;
};
protocol PTest
{
child:
  StructData(Pos pos);
};
```
```c
c++:
class PTestChild
{
  virtual bool RecvStructData(const Pos& pos) = 0;
};
```
* union

</script>
</section>
<section data-markdown >
<script type="text/template">
### Message Data Type(Cont'd)

* array
```c
protocol PTest
{
child:
	ArrayData(int32_t[] array);
};
```
```c
c++:
class PTestChild
{
	virtual bool RecvArrayData(nsTArray<int32_t>&& array) = 0;
};
```
* actor
	* send an actor parent will convert it to an actor child on the other side
* file descriptor
	* currently, only supprt for posix system
	* linux: SOL_SOCKET and SCM_RIGHTS flag
	* please check ipc_channel_posix.cc
* shared memory
	* please check shared_memory_posix.cc and shared_memory_win.cc
* !!! The parameter is a temporary object, user should make a copy if needs. !!!

</script>
</section>
</section>
<section data-markdown >
<script type="text/template">
### sync/async Semantic

```c
                                PTestParent.h:
PTest.ipdl:                     class PTestParent
sync protocol PTest             {
{                               protected:
child:                            virtual bool RecvChildToParent(const int32_t& num, int* ans, bool* result) = 0;
  async ParentToChild();        };
parent:                              PTestChild.h:
  sync ChildToParent(int32_t num)    class PTestChlid
    returns (int ans, bool result);  {
both:                                public:
  async BothDirection();               bool SendChildToParent(const int32_t& num, bool* result);
};                                   };
```

* Async
	* sender is not blocked
	* IPDL use async by default
* Sync
	* sender blocks until the receiver receives the message and sends back a reply if needs
		* onlys sync call may have return values
	* sync only can used from child to parent.

</script>
</section>
<section data-markdown >
<script type="text/template">
### intr Semantic

* intr represent a sync and re-entrant messages

```c
intr protocol PTest
{
child:
  intr IntrParentToChild();
parent:
  intr IntrChildToParent();
};
```
```c
eg:
CallIntrChildToParent()    ->    AnswerIntrChildToParent()
                                       |
                                       |
AnswerIntrParentToChild()  <-    CallIntrParentToChild()
```

* !!! They're basically used for plugins. Just pretend that they don't exist. !!!

</script>
</section>
<section data-markdown >
<script type="text/template">
### priority Semantic

* prio(normal), prio(high) and prio(urgent)
* check MessageChannel.cpp for detail
```c
prio(normal upto high) protocol PTest
{
child:
  prio(high) async AsyncHighParentToChild();
parent:
  sync SyncNormalChildToParent();
};
```
```c
eg:
SyncNormalChildToParent()     ->    RecvNormalChildToParent()
                                           |
                                           |
RecvAsyncHighParentToChild()  <-    SendAsyncHighParentToChild()
```

* !!! This is incredibly dangerous. You should make sure the sync-calling code is completely unrelated to the incoming high priority message. !!!

</script>
</section>
<section data-markdown >
<script type="text/template">
### compress Semantic

* remove the redundant message
* could be used with async message

```c
PBrowser.ipdl
prio(normal upto urgent) intr protocol PBrowser
{
  UpdateDimensions(...) compress;
};
```

* please check MessageChannel::OnMessageReceivedFromLink and Bug 1076820

</script>
</section>
<section>
<section data-markdown >
<script type="text/template">
### Subprotocol

```c
PTest.ipdl
include protocol PTestSubtree;            PTestSubtree.ipdl
sync protocol PTest                       include protocol PTest;
{                                         protocol PTestSubtree
  manages PTestSubtree;                   {
child:                                      manager PTest;
  async ParentToChild();                  child:
parent:                                     //delete from parent to child
  //create from child to parent.            __delete__();
  sync PTestSubtree(int32_t data)           ParentToChild();
    returns (bool result);                };
};
```
```c
PTestParent.h
class PTestParent
{
  virtual bool RecvPTestSubtreeConstructor(PTestSubtreeParent* actor, const int32_t& data, bool* result);
  virtual void ActorDestroy(ActorDestroyReason why) MOZ_OVERRIDE;
  virtual PTestSubtreeParent* AllocPTestSubtreeParent(const int32_t& data, bool* result) = 0;
  virtual bool DeallocPTestSubtreeParent(PTestSubtreeParent* aActor) = 0;
};
```
```c
PTestChild.h
class PTestChild
{
	PTestSubtreeChild* SendPTestSubtreeConstructor(onst int32_t& data, bool* result);
	virtual void ActorDestroy(ActorDestroyReason why) = 0;
  virtual PTestSubtreeChild* AllocPTestSubtreeChild(const int32_t& data, bool* result) = 0;
  virtual bool DeallocPTestSubtreeChild(PTestSubtreeChild* aActor) = 0;
};
```

</script>
</section>
<section data-markdown >
<script type="text/template">
### Subprotocol(Cont'd)

```c
PTest.ipdl
include protocol PTestSubtree;            PTestSubtree.ipdl
sync protocol PTest                       include protocol PTest;
{                                         protocol PTestSubtree
  manages PTestSubtree;                   {
child:                                      manager PTest;
  async ParentToChild();                  child:
parent:                                     //delete from parent to child
  //create from child to parent.            __delete__();
  sync PTestSubtree(int32_t data)           ParentToChild();
    returns (bool result);                };
};
```
```c
PTestSubtreeChild.h
class PTestSubtreeChild
{
    virtual bool Recv__delete__();
    virtual void ActorDestroy(ActorDestroyReason why) = 0;
};
```
```c
PTestSubtreeParent.h
class PTestSubtreeParent
{
	static bool Send__delete__(PTestSubtreeParent* actor);
	virtual void ActorDestroy(ActorDestroyReason why) = 0;
};
```

</script>
</section>
</section>
<section>
<section data-markdown >
<script type="text/template">
### Actor Lifetime

* create actor
	* top-level protocol PTest
		* call PTestParent::Open()
	* subprotocol PTestSubtree
  	* call PTestChild::SendPTestSubtreeConstructor()
* the corresponding AllocPTest* will be called

</script>
</section>
<section data-markdown >
<script type="text/template">
### Actor Lifetime(Cont'd)

* destroy actor
	* Top-level protocol PTest
	* call PTestParent::Close() to close the channel.
  	* PTestParent::DestroySubtree()
  		* PTestParent::ActorDestroy()
  	* PTestParent::DeallocSubtree()
	* subprotocol PTestSubtree
  	* parent:
  		* PTestSubtreeParent::Send\_\_delete\_\_()
  	* child:
    	* PTestSubtreeChild::Recv\_\_delete\_\_()
      	* PTestSubtreeChild::DestroySubtree()
      		* PTestSubtreeChild::ActorDestroy()
      	* unregister itself from its manager

</script>
</section>
</section>
<section data-markdown >
<script type="text/template">
### Thread Model

```c
       Chrome                                              Content
                                          +
                                          |
                                          |
+---+--+----+         +-----------+       |       +-----------+        +---+--+----+
|Top-level  |         |    IO     |       |       |    IO     |        |Top-level  |
|Protocol   | <-----> |MessageLoop| <-----+-----> |MessageLoop| <----> |Protocol   |
|MessageLoop|         +-----------+     unix      +-----------+        |MessageLoop|
+-----------+                          domain                          +-----------+
                         ^             socket             ^
+---+--+----+            |                +               |            +---+--+----+
|Top-Level  |            |                |               |            |Top-level  |
|Protocol   | <----------+                +               +----------> |Protocol   |
|MessageLoop|                                                          |MessageLoop|
+-----------+                                                          +-----------+
```

* top-level protocol and its subprotocol will run on the thread which call Open()
* each top-level protocol has its own IPC channel.
* please check MessageChannel::Open()

</script>
</section>
<section data-markdown >
<script type="text/template">
### Debug IPC

* build debug version
* export environment variable "MOZ_IPC_MESSAGE_LOG=1" or "MOZ_IPC_MESSAGE_LOG=$TOP_LEVEL_PROTOCOL_NAME"

</script>
</section>
<section data-markdown >
<script type="text/template">
### QA???
</script>
</section>
            </div>
        </div>
        <script src="lib/js/head.min.js"></script>
        <script src="js/reveal.min.js"></script>
        <script>
            Reveal.initialize({
                controls: true,
                progress: true,
                history: false,
                keyboard: true,
                touch: true,
                center: true,
                loop: false,
                rtl: false,
                mouseWheel: false,
                margin: 0,
                minScale: 0.5,
                maxScale: 1.0,
                autoSlide: 0,
                width: 1280,
                height: 800,
                theme: 'night',
                transition: "default",
                transitionSpeed: "default",
                backgroundTransition: "default",
                // Optional libraries used to extend on reveal.js
                dependencies: [
                    { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
                    { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
                    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
                    { src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
                    { src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } },
                    { src: 'plugin/math/math.js', async: true }
                ]
            });
        </script>
    </body>
</html>
